<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>基于EEG与人工智能的睡眠健康评估系统 V1.0</title>
  {% load static %}
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <style>
    /* 全局样式 */
    body { 
      margin: 0;
    }
    .app-container {
      font-family: 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 20px;
      /* background: linear-gradient(135deg, #0a0a2a, #001f6e); */
      /* background: linear-gradient(to right, rgb(15, 12, 41), rgb(48, 43, 99), rgb(36, 36, 62)); */
      background: linear-gradient(to right, rgba(0, 0, 70, 0.3), rgba(28, 181, 224, 0.3)), url('{% static "images/背景鲸鱼.jpg" %}');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height: 100vh;
      color: #fff;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-container {
      width: 120px;
      height: 120px;
      margin: 50px auto 0px auto;
      display: block;
    }

    .logo-container img {
      width: 120px;
      height: auto;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    .title {
      color: #ffd000;
      font-size: 1.8rem;
      margin: 10px 0;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
    }

    .subtitle {
      color: #99ccff;
      font-size: 0.9rem;
      margin-top: 5px;
    }

    .status-bar {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 20px;
    }

    .el-icon-circle-check {
      color: #00ff00;
      animation: pulse 2s infinite;
      
    }

    .el-icon-circle-cross {
      color: #ff0000;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      
    }
    .custom-input input {
      margin-top: 5px;
      border: 2px solid #00ffff !important;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.7) !important;
      border-radius: 8px !important;
      background-color: rgba(51, 128, 158, 0.8) !important;
      color: #fff !important;
    }
    .el-button {
      border: 1px solid #00ffff;
      border-radius: 8px;
      padding: 10px 20px;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
      transition: all 0.3s ease;
      background: transparent;
      color: #00ffff;
      font-size: 20px;
    }
    #scann_button{
      margin-top: 8px;
      font-size: 16px;
      
    }

    .el-button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
    }

    .el-button[type="primary"] {
      background: transparent;
      color: #00ffff;
    }

    .el-button[type="success"] {
      background: transparent;
      color: #00ff00;
    }

    .el-button[type="warning"] {
      background: transparent;
      color: #ffcc00;
    }

    .el-button[type="info"] {
      background: transparent;
      color: #00ccff;
    }

    .main-content {  
      margin-left: 12.5%;
      width: 75%;
      display: flex;
      gap: 20px;
    }
        /* 固定标签页内容区域 */
    .tab-content-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 400px; /* 设置最小高度 */
      max-height: 600px; /* 设置最大高度 */
      height: 500px; /* 设置固定高度 */
    }
    
    .tab-pane-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(0, 20, 40, 0.6);
      border-radius: 8px;
      border: 1px solid #00aaff;
      box-shadow: 0 0 10px rgba(51, 142, 253, 0.301);
    }
    .sidebar {
      width: 350px;
      height: 700;
      background: rgba(47, 99, 242, 0.297);
      border: 1px solid #00ffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }

    .card {
      margin-bottom: 20px;
      border-bottom: 1px solid #00ffff;
      padding-bottom: 16px;
    }

    .card h3 {
      margin-top: 0;
      font-size: 1rem;
      color: #00ffff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin: 10px 0;
    }

    .status-info {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #99ccff;
    }

    .data-status {
      padding: 10px;
      background: rgba(104, 104, 111, 0.506);
      border-radius: 4px;
      margin-top: 10px;
      color: #00ffff;
    }

    .history-file {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #99ccff;
    }

    /* 主内容 */
    .main-panel {
      flex: 1;
      background: rgba(27, 27, 82, 0.5);
      border: 1px solid #00ffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(63, 109, 158, 0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .main-panel .el-tabs {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .main-panel .el-tabs__content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .main-panel .el-tab-pane {
      flex: 1;
      overflow-y: auto;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
 
    .data-flow {
      text-align: center;
      padding: 40px;
      color: #99ccff;
      font-size: 1rem;
      flex: 1;
      overflow-y: auto;
    }

    .placeholder {
      height: 100%;
      overflow-y: auto;
      text-align: left;
      white-space: pre-wrap;
      color: #00ffff;
      font-family: monospace;
      line-height: 1.5;
      background: rgba(28, 48, 74, 0.345);
      padding: 10px;
      border-radius: 8px;
      flex: 1;
    }
    /* 主内容 */

    .clear-log-btn {
      text-align: right;
      margin-top: 10px;
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      color: #99ccff;
      font-size: 0.8rem;
      text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
    }

    /* 标签页样式 */
    .el-tabs__item {
      color: #99ccff !important;
      font-weight: bold;
    }

    .el-tabs__item.is-active {
      color: #00ffff !important;
      border-bottom: 2px solid #00ffff;
    }

    .el-tabs__nav {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div id="app" class="app-container">
    <!-- 头部 -->
    <header class="header">
      <div class="logo-container">
        <img src="{% static 'images/logo.jpg' %}" alt="云梦泽 - Yun Meng Ze">
      </div>
      <h1 class="title">基于EEG与人工智能的睡眠健康评估系统 V2.0</h1>
      <p class="subtitle">实时采集 · 本地存储 · 智能分析</p>
    </header>

    <!-- 状态指示 -->
    {% verbatim %}
    <div class="status-bar">
      <span class="status-item"><i class="el-icon-circle-check" style="color: green;"></i> 后端: 已连接</span>
      <span class="status-item"><i :class="isConnected ? 'el-icon-circle-check' : 'el-icon-circle-cross'" :style="{color: isConnected ? 'green' : 'red'}"></i> 设备: {{ deviceStatus }}</span>
      <span class="status-item"><i :class="isRecording ? 'el-icon-circle-check' : 'el-icon-circle-cross'" :style="{color: isRecording ? 'green' : 'red'}"></i> 数据: {{ isRecording ? '正在记录' : '未连接' }}</span>
      <span class="status-item"><i class="el-icon-circle-cross" style="color: red;"></i> API: 未连接</span>
    </div>

    <!-- 操作按钮 -->
    <div class="button-group">
      <el-button  type="primary" @click="connectDevice" >连接设备</el-button>
      <el-button type="success" @click="startRecording">{{ isRecording ? '停止记录' : '开始记录' }}</el-button>
      <el-button type="warning" @click="analyzeData">分析数据</el-button>
      <el-button type="info" @click="importData">导入数据</el-button>
      <el-button type="text" @click="testBackend">测试后端连接</el-button>
    </div>

    <!-- 主体内容 -->
    <div class="main-content">
      <!-- 左侧侧边栏 -->
      <div class="sidebar">
        <!-- 设备连接 -->
        <div class="card">
          <h3><i class="el-icon-mobile-phone"></i> 设备连接</h3>
          <div class="form-group">
            <label>蓝牙设备地址</label>
            <el-input class="custom-input" v-model="deviceAddress" placeholder="例如: JDY-18"></el-input>
            <el-button id="scann_button" type="primary" size="small" @click="scanDevices">扫描</el-button>
          </div>
          <div class="status-info">
            <p>连接状态: <span style="color: red;">未连接</span></p>
            <p>信号质量: <span>-- /200</span></p>
          </div>
        </div>

        <!-- 数据保存 -->
        <div class="card">
          <h3><i class="el-icon-document"></i> 数据保存</h3>
          <div class="data-status">
            <p>{{ dataStatus }}</p>
          </div>
        </div>

        <!-- 分析配置 -->
        <div class="card">
          <h3><i class="el-icon-setting"></i> 分析配置</h3>
          <div class="form-group">
            <label>API密钥</label>
            <el-input  class="custom-input" v-model="apiKey" placeholder="请输入API密钥"></el-input>
          </div>
          <el-button type="primary" size="small" @click="testAPI">测试API</el-button>
          <div class="history-file">
            <p>历史数据文件</p>
            <p style="color: #99ccff;">暂无历史数据</p>
          </div>
        </div>
      </div>

      <!-- 右侧主内容区 -->
      <div class="main-panel">
        <el-tabs v-model="activeTab">
          <el-tab-pane label="实时数据" name="realtime">
            <div class="tab-content-container">
              <div class="tab-pane-content">
                <div class="data-flow">
                  <i class="el-icon-info"></i>
                  <p>未连接设备，请先连接设备开始采集数据</p>
                </div>
              </div>
            </div>
          </el-tab-pane>
          <el-tab-pane label="分析报告" name="report">
            <div class="tab-content-container">
              <div class="tab-pane-content">
                <div class="placeholder" v-if="!reportContent">分析报告内容将显示在此处</div>
                <div v-else class="report-content" v-html="reportContent"></div>
              </div>
            </div>
          </el-tab-pane>
          <el-tab-pane label="系统日志" name="log">
            <div class="tab-content-container">
              <div class="tab-pane-content">
                <div class="placeholder" v-text="logContent || '系统日志将显示在此处'"></div>
              </div>
            </div>
          </el-tab-pane>
        </el-tabs>
        <div class="clear-log-btn">
          <el-button type="text" @click="clearLog">清空日志</el-button>
        </div>
      </div>
    </div>

    <!-- 底部 -->
    <footer class="footer">
      基于EEG与人工智能的睡眠健康评估系统 V1.0 | 本地数据安全存储 | 支持CSV/Excel数据分析
    </footer>
  </div>

  <script>
    new Vue({
      el: '#app',
      data: {
        deviceAddress: '',
        apiKey: '51e09aa5-d2dd-41ab-bf91-51ef798844e7',
        activeTab: 'realtime',
        websocket: null,
        isConnected: false,
        isRecording: false,
        deviceStatus: '未连接',
        signalQuality: '-- /200',
        dataStatus: '未保存数据',
        logContent: '',
        reportContent: '',
        historyFiles: [],
        importedFileName: '',
        currentFilePath: ''
      },
      methods: {
        connectDevice: function() {
          if (this.isConnected) {
            this.$message.info('设备已连接');
            return;
          }
          
          try {
            this.websocket = new WebSocket('ws://' + window.location.host + '/ws/eeg/');
            
            this.websocket.onopen = () => {
              this.isConnected = true;
              this.deviceStatus = '已连接';
              this.$message.success('设备连接成功');
            };
            
            this.websocket.onmessage = (event) => {
              const data = JSON.parse(event.data);
              this.handleWebSocketMessage(data);
            };
            
            this.websocket.onclose = () => {
              this.isConnected = false;
              this.isRecording = false;
              this.deviceStatus = '未连接';
              this.$message.info('设备连接已断开');
            };
            
            this.websocket.onerror = (error) => {
              this.$message.error('连接发生错误: ' + error);
            };
          } catch (error) {
            this.$message.error('连接失败: ' + error.message);
          }
        },
        
        startRecording: function() {
          if (!this.isConnected) {
            this.$message.warning('请先连接设备');
            return;
          }
          
          this.isRecording = !this.isRecording;
          
          if (this.isRecording) {
            this.sendEEGData();
            this.$message.success('开始记录EEG数据');
          } else {
            this.$message.info('已停止记录');
          }
        },
        
        sendEEGData: function() {
          if (!this.isRecording || !this.isConnected) return;
          
          const eegData = {
            type: 'eeg_data',
            timestamp: new Date().toISOString(),
            data: this.generateMockEEGData()
          };
          
          try {
            this.websocket.send(JSON.stringify(eegData));
            this.dataStatus = '正在记录数据...';
          } catch (error) {
            this.$message.error('发送数据失败: ' + error.message);
          }
          
          if (this.isRecording) {
            setTimeout(() => this.sendEEGData(), 1000);
          }
        },
        
        generateMockEEGData: function() {
          const bands = ['Delta', 'Theta', 'Alpha', 'Beta', 'Gamma'];
          const data = bands.map(band => {
            return band + ' ' + Math.floor(Math.random() * 100);
          });
          return data.join(' ');
        },

        analyzeData: function() {
          if (this.importedFileName && this.currentFilePath) {
            this.analyzeExistingFile(this.currentFilePath);
            return;
          }
          
          if (!this.isConnected) {
            this.$message.warning('请先连接设备或导入数据文件');
            return;
          }
          
          const analysisRequest = {
            type: 'request_analysis',
            api_key: this.apiKey
          };
          
          try {
            this.websocket.send(JSON.stringify(analysisRequest));
            this.$message.info('正在分析数据...');
          } catch (error) {
            this.$message.error('发送分析请求失败: ' + error.message);
          }
        },
        
        analyzeExistingFile: function(filePath) {
          fetch('/api/analyze-existing-data/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              file_path: filePath,
              api_key: this.apiKey
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              this.$message.success(data.message);
              this.logContent += `[${new Date().toLocaleTimeString()}] ${data.message}\n`;
              this.loadReport(data.report_filename);
            } else {
              this.$message.error(data.message);
              this.logContent += `[${new Date().toLocaleTimeString()}] 分析失败: ${data.message}\n`;
            }
          })
          .catch(error => {
            this.$message.error('分析请求失败: ' + error.message);
            this.logContent += `[${new Date().toLocaleTimeString()}] 分析请求失败: ${error.message}\n`;
          });
        },
        
        loadReport: function(filename) {
          fetch(`/reports/${filename}`)
          .then(response => response.text())
          .then(html => {
            this.reportContent = html;
            this.activeTab = 'report';
          })
          .catch(error => {
            this.$message.error('加载报告失败: ' + error.message);
          });
        },
        
        importData: function() {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = '.csv,.xlsx,.xls,.txt';
          
          fileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/import-eeg-data/', {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'success') {
                this.$message.success(data.message);
                this.logContent += `[${new Date().toLocaleTimeString()}] ${data.message}\n`;
                this.dataStatus = `已导入: ${file.name}`;
                this.importedFileName = file.name;
                this.currentFilePath = data.file_path;
                
                if (this.isConnected) {
                  const importNotification = {
                    type: 'imported_data',
                    fileName: file.name,
                    filePath: data.file_path
                  };
                  this.websocket.send(JSON.stringify(importNotification));
                }
              } else {
                this.$message.error(data.message);
                this.logContent += `[${new Date().toLocaleTimeString()}] 导入失败: ${data.message}\n`;
              }
            })
            .catch(error => {
              this.$message.error('文件上传失败: ' + error.message);
              this.logContent += `[${new Date().toLocaleTimeString()}] 文件上传失败: ${error.message}\n`;
            });
          };
          
          fileInput.click();
        },
        
        testBackend: function() {
          this.$message.success('后端连接正常');
        },
        
        scanDevices: function() {
          this.$message.info('正在扫描蓝牙设备...');
          setTimeout(() => {
            this.$message.success('扫描完成，未发现可用设备');
          }, 2000);
        },
        

 


        testAPI: function() {
          if (!this.apiKey) {
            this.$message.warning('请输入API密钥');
            return;
          }
          
          const loading = this.$loading({
            lock: true,
            text: '测试中...',
            spinner: 'el-icon-loading',
            background: 'rgba(0, 0, 0, 0.7)'
          });
          
          fetch('/api/test-api-key/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              api_key: this.apiKey
            })
          })
          .then(response => response.json())
          .then(data => {
            loading.close();
            if (data.status === 'success') {
              this.$message.success(data.message);
            } else {
              this.$message.error(data.message);
            }
          })
          .catch(error => {
            loading.close();
            this.$message.error('测试请求失败: ' + error.message);
          });
        },
        
        clearLog: function() {
          this.logContent = '';
          this.$message.success('日志已清空');
        },
        
        handleWebSocketMessage: function(data) {
          switch (data.type) {
            case 'data_received':
              this.logContent += `[${new Date().toLocaleTimeString()}] 数据已接收: ${data.timestamp}\n`;
              break;
              
            case 'data_error':
              this.$message.error('数据处理错误: ' + data.error);
              this.logContent += `[${new Date().toLocaleTimeString()}] 错误: ${data.error}\n`;
              break;
              
            case 'import_success':
              this.$message.success('导入数据已成功保存到服务器');
              this.logContent += `[${new Date().toLocaleTimeString()}] 导入数据已保存: ${data.file_path}\n`;
              break;
              
            case 'analysis_result':
              if (data.success) {
                this.reportContent = data.content;
                this.activeTab = 'report';
                this.$message.success('分析完成');
                this.logContent += `[${new Date().toLocaleTimeString()}] 分析完成\n`;
              } else {
                this.$message.error('分析失败: ' + data.error);
                this.logContent += `[${new Date().toLocaleTimeString()}] 分析失败: ${data.error}\n`;
              }
              break;
              
            case 'error':
              this.$message.error('服务器错误: ' + data.message);
              this.logContent += `[${new Date().toLocaleTimeString()}] 服务器错误: ${data.message}\n`;
              break;
          }
          
          this.$nextTick(() => {
            const logPanel = document.querySelector('.el-tab-pane[name="log"] .placeholder');
            if (logPanel) {
              logPanel.scrollTop = logPanel.scrollHeight;
            }
          });
        }
      },
      
      watch: {
        isRecording: function(newVal) {
          this.dataStatus = newVal ? '正在记录数据...' : '未保存数据';
        }
      },
      
      mounted: function() {
        this.testBackend();
      }
    });
  </script>
  {% endverbatim %}
</body>
</html>